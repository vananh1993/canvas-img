<!DOCTYPE html>
<html>
    <head>
        <title>Page Title</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    </head>
    <body>
        <style type="text/css">
            body{
            background-color: #cccccc;
            }
            .lw { font-size: 60px; }
            canvas{
            border-style: dashed;  
            }
            button{
            margin:30px;
            }
            div{
            /*   border-style: solid; */
            /*   border-color: #98bf21; */
            }
            img {
            max-width: 100%;
            }
            ul, li {
            list-style: none;
            margin: 0;
            padding-left: 0;
            }
        </style>
        <div class="container">
            <div class="row">
                <div class="col-4">
                    <ul id="frame">
                        <li>
                            <img src="./img/transparent-1.png">
                        </li>
                        <li>
                            <img src="./img/transparent-2.png">
                        </li>
                        <li>
                            <img src="./img/transparent-3.png">
                        </li>
                        <li>
                            <img src="./img/transparent-4.png">
                        </li>
                    </ul>
                </div>
                <div class="col-8">
                    <div class="mb-4">
                        <span><input type="file" name="images" id="uploadImg" accept="image/*;capture=camera"  capture></span>
                    </div>
                    <!-- A canvas tag is required or 
                        Fabric.js doesn't know where to draw. -->
                    <canvas id="c" width="500" height="500"></canvas>
                    <br/>
                </div>
            </div>
        </div>
        <!-- <canvas id="cv" width="500" height="500"></canvas> -->
        <button type="button" id="btn"> Export&Import SVG</button>
        <button type="button" id="btn_edit"> Export&Import JSON </button>  
        <!--  <p>Export to SVG</p> 
            <div id="svg-tag"></div>
             
            <p>Import from SVG</p> 
            <canvas id="canvas-svg" width="500" height="500"></canvas>  
            <p>Import from JSON</p> 
            <canvas id="canvas" width="500" height="500"></canvas> 
            -->
        <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.7.0/fabric.js"></script>
        <script type="text/javascript">
            /* Write JavaScript here */
            
            var imgSrc ='http://th09.deviantart.net/fs71/PRE/i/2012/340/7/b/png_bird_by_moonglowlilly-d5n88u2.png';
            var canvas = new fabric.Canvas('c');

            canvas.controlsAboveOverlay = true; 
           
            function setName(obj,name){
              obj.toObject = (function(toObject) {
              return function() {
                return fabric.util.object.extend(toObject.call(this), {
                  name: this.name
                });
              };
            })(obj.toObject);
              obj.name = ''+name;
            }




            var imageObject;
            let imgFrame = $('#frame img');
            let imgFrameSrc = imgFrame.attr('src');
            // if(imgFrameSrc != "") {
                fabric.Image.fromURL('https://picsum.photos/200/200', function(img) {
                    img.set({width:200,height:200,scaleX:1,scaleY:1})
                    imageObject = img;
                    canvas.add(img);
            });
            // }
            
            var i=0;

            function changeSrc(imgFrameSrc){
              // var url = 'https://picsum.photos/200/200?random='+ ++i;
              imageObject.setSrc(imgFrameSrc,function(){
                canvas.requestRenderAll();
              })
            }

            imgFrame.on( "click", function() {
                imgFrameSrc = $(this).attr('src');
                changeSrc(imgFrameSrc)
            
            });
           

            // var imageObject;
            
            // let imgFrame = $('#frame img');
            // let imgFrameSrc = imgFrame.attr('src');
            // fabric.Image.fromURL(
            //     "https://www.tutorialspoint.com/images/logo.png",
            //     function(Img) {
            //         imageObject = Img;
            //         canvas.add(Img).renderAll();
            //     }, {
            //         crossorigin: "anonymous"
            //     }
            // );
            // imgFrame.on( "click", function() {
            //   imgFrameSrc = $(this).attr('src');
            //   // console.log(imgFrameSrc);
            //   // img1 = loadImage(imgFrameSrc, main);
            //     imageObject.setSrc(
            //         imgFrameSrc,
            //         function() {
            //             canvas.renderAll();
            //         }
            //     );
            // //   fabric.Image.fromURL(imgFrameSrc, function(oImg) {
            // //     oImg.set({
            // //       scaleX: 500 / oImg.width,
            // //       scaleY: 500 / oImg.height
            // //     });
            // //     canvas.centerObject(oImg);
            // //     oImg.set('selectable', false);
            // //     canvas.add(oImg);  
            // // });
            
            // });
            
            function addImage(imgLink) {
                fabric.Image.fromURL(imgLink, function(img) {
                    // img.set({
                    //   scaleX: 500 / img.width,
                    //   scaleY: 500 / img.height
                    // });
                    img.scaleToWidth(500);
                    // img.scaleToHeight(500);
                    canvas.centerObject(img);   
                    var objs = canvas.getObjects();
                    if (objs.length) {
                        objs.forEach(function(e) {
                            if (e && e.type === 'image') {
                                e._element.src = imgLink;
                                canvas.renderAll();
                            }
                        });
                    } else canvas.add(img);
                });
            }

            // addImage('http://lorempixel.com/400/200');

            // file upload
            var span = document.querySelector('#uploadImg');
            span.onchange = function(e) {
                var file = e.target.files[0];
                var reader = new FileReader();
                reader.onload = function(file) {
                    addImage(file.target.result);
                }
                reader.readAsDataURL(file);
            }
            


            // document.getElementById('uploadImg').onchange = function handleImage(e) {
            //     console.log(e.target.files[0])
            //     var reader = new FileReader();
            //   reader.onload = function (event){
            //     var imgObj = new Image();
            //     imgObj.src = event.target.result;
            //     imgObj.onload = function () {
            //       var image = new fabric.Image(imgObj);
            //       image.set({
            //             angle: 0,
            //             padding: 10,
            //             cornersize:10,
            //             scaleX: 500 / image.width,
            //             scaleY: 500 / image.height,
            //             // height:110,
            //             // width:110,
            //       });
            //       canvas.centerObject(image);
            //       canvas.add(image);
            //       canvas.sendToBack(image);
            //       // canvas.renderAll();
            //     }
            //   }
            //   reader.readAsDataURL(e.target.files[0]);
            // }
            
            
            
            $('#btn').click(function(){
               var trsvg = canvas.toSVG();
               // var trsvg_cv = cv.toSVG();
               var canvas_svg = new fabric.Canvas('canvas-svg');
               $('#svg-tag').html(trsvg);
                 //alert(JSON.stringify(trsvg));    
                //alert(JSON.stringify(canvas.toDatalessJSON()));
               var stringa = canvas.toJSON;    
              
               fabric.loadSVGFromString( trsvg , function (objects, options) {
                 var obj = fabric.util.groupSVGElements(objects, options);
                 canvas_svg.add(obj).centerObject(obj);
                 obj.setCoords();
                 canvas_svg.calcOffset();
                 canvas_svg.renderAll();
                  //alert('sss');  
               }); 
              
            });
              // Attach it to the canvas object, then (re)display
              // the canvas. 
            /*
            circle.animate('left', 10, {
                onChange: canvas.renderAll.bind(canvas),
                duration: 5000,
                easing: fabric.util.ease.easeOutBounce
            });*/
            //cv.add(hi);
            // canvas.add(circle);
            // canvas.add(recta);
            //recta.name = 'recta';
            //hi.name ='hi';
            // canvas.add(hi);
             //  canvas.add(his); 
            
            $('#btn_edit').click(function(){
            var canvas_ = new fabric.Canvas('canvas');
            console.log('Click Edit');
              
              
            //JSON DATA   
            var json_data = JSON.stringify(canvas.toDatalessJSON()); 
            console.log(json_data);
            //LOAD JSON DATA
            
            canvas_.loadFromJSON(JSON.parse(json_data), function(obj) {
              canvas_.renderAll();
               console.log(' this is a callback. invoked when canvas is loaded!xxx ');
               
              canvas_.forEachObject(function(obj){
                console.log(obj.name);
              
                if(obj.name === 'recta'){      
                  obj.set({
                            left: 100,
                            top:200,
                            height: 700,
                            width: 700,
                            scaleX: .35,
                            scaleY:.35,
                    lockScalingY: .35
                        });
                        
                  canvas_.add(obj); 
                }
                
              });
            
                 
            });  
            
              
              /*
            canvas_.loadFromJSON(json_data, function() {
                canvas_.renderAll();
            });
              */
            });
            //Load imange from url
            
            
            /**
            function loadImage(url, callback, context) {
              if (url) {
                var img = new Image();
                // @ignore 
                img.onload = function () { 
                  callback && callback.call(context, img);
                  img = img.onload = null;
                };
                img.src = url;
              }
            }
            
            var v=document.getElementById("video1");
            var cv_=document.getElementById("c");
            ctx=cv_.getContext('2d');
            v.addEventListener('play', function() {
              var i=window.setInterval(function(){
                ctx.drawImage(v,5,5,260,125)},0,0);                                   
               },false);
            v.addEventListener('pause',function() {window.clearInterval(i);},false);
            v.addEventListener('ended',function() {clearInterval(i);},false); 
            */
            /* 
            fabric.Object.prototype.transparentCorners = false;
            
              var canvas = this.__canvas = new fabric.Canvas('c', {
                backgroundColor: '#333',
                HOVER_CURSOR: 'pointer'
              });
            
              var PolaroidPhoto = fabric.util.createClass(fabric.Object, fabric.Observable, {
                H_PADDING: 20,
                V_PADDING: 50,
                originX: 'center',
                originY: 'center',
                initialize: function(src, options) {
                  this.callSuper('initialize', options);
                  this.image = new Image();
                  this.image.src = src;
                  this.image.onload = (function() {
                    this.width = this.image.width;
                    this.height = this.image.height;
                    this.loaded = true;
                    this.setCoords();
                    this.fire('image:loaded');
                  }).bind(this);
                },
                _render: function(ctx) {
                  if (this.loaded) {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(
                      -(this.width / 2) - this.H_PADDING,
                      -(this.height / 2) - this.H_PADDING,
                      this.width + this.H_PADDING * 2,
                      this.height + this.V_PADDING * 2);
                    ctx.drawImage(this.image, -this.width / 2, -this.height / 2);
                  }
                }
              });
              var photo = new PolaroidPhoto('http://fabricjs.com/assets/pug.jpg', {
                top: 200,
                left: 200,
                scaleX: 0.2,
                scaleY: 0.2
              });
              photo.on('image:loaded', canvas.renderAll.bind(canvas));
              photo.drawBorders = photo.drawCorners = function() { return this };
            
              function makeHandler(arg) {
                return function(e) {
                  if (e.target) {
                    e.target.animate('angle', arg, {
                      duration: 100,
                      onChange: canvas.renderAll.bind(canvas)
                    });
                  }
                };
              }
              canvas.on({
                'mouse:down': makeHandler('+10'),
                'mouse:up': makeHandler('-10')
              });
              canvas.add(photo);*/
            
            
            /*
            
            var LabeledRect = fabric.util.createClass(fabric.Rect, {
            
              type: 'labeledRect',
            
              initialize: function(options) {
                options || (options = { });
            
                this.callSuper('initialize', options);
                this.set('label', options.label || '');
              },
            
              toObject: function() {
                return fabric.util.object.extend(this.callSuper('toObject'), {
                  label: this.get('label')
                });
              },
            
              _render: function(ctx) {
                this.callSuper('_render', ctx);
            
                ctx.font = '20px Helvetica';
                ctx.fillStyle = '#333';
                ctx.fillText(this.label, -this.width/2, -this.height/2 + 20);
              }
            });
            var labeledRect = new LabeledRect({
              width: 100,
              height: 50,
              left: 100,
              top: 100,
              label: 'test',
              fill: '#faa'
            });
            canvas.add(labeledRect);*/
        </script>
    </body>
</html>